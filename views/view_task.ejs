<%

	var req_path = req.path;
	
	var task = {};
	sails.config.tasks.forEach(function(t){
		if(t.config.slug==req.params.slug)
			task = t;
	})
	var folder_path=task.path.replace(sails.config.microlight.task_folder+'/','').replace('/'+task.file,'').split('/');

%>
<div class='ui basic segment container'>

	<div class="ui breadcrumb">
		<a class="section" href='/library'>Library</a>
		<% var path = '/library'%>
		<%folder_path.forEach(function(folder){%>
		<% path +='/'+folder%>
		<i class="right angle icon divider"></i>
		<a class="section" href='<%=path%>'><%=folder%></a>
		<%})%>
		<i class="right angle icon divider"></i>
		<div class="section"><%=task.config.name%></div> 
	</div>
	<h1 style='margin-top:0;'>
		<span style='opacity: 0.5;'>Task: </span><span data-content="<%=task.config.name%>"><%= task.config?.name?.length > 47 ? task.config?.name?.substring(0, 47) + '...' : task.config.name %></span>

		
		<div class="ui compact basic icon button right floated dropdown">
			<i class="middle aligned ellipsis vertical icon" style="margin-left: 4px;"></i>
			<div class="menu" style="margin-top: 4px;">
				<div class="item" id="edit_modal">
					<i class="edit icon"></i> Edit
				</div>
			</div>
		</div>
		
		
	</h1>
	<div class='ui segment'>
		<!-- <pre><%=JSON.stringify(task,2,2)%></pre> -->
		<form action="/task/<%=req.params.slug%>/execute" method="post" class='ui <%-req.query.error?"req.query.error":""%> form' enctype="multipart/form-data">
			<div class="ui error message">
				<div class="header">Please correct error in form</div>
				<p><%-req.query.error%></p>
			</div>
			<% Object.keys(task.config.inputs).forEach(function(key){%>
				<%- include('partials/input',{input:{key,config:task.config.inputs[key]}})%>
			<%})%>
			
			<input type="submit" class='ui teal button' value="Execute task">
		</form>
	</div>
	<h3>Schedule:</h3>
	<h3>Recent runs:</h3>
	<table class="ui celled unstackable collapsing table">
	    <thead>
	        <tr>
	            <th>Date</th>
	            <th>ID</th>
	            <th>Status</th>
	            <th>Duration</th>
	            <th>By</th>
	            <th>User</th>
	        </tr>
	    </thead>
	    <tbody>
	    	<%runs.forEach(function(run){%>
	        <tr>
	            <td><%=run.createdAt.toISOString()%></td>
	            <td><a href='/task/<%=run.task%>/run/<%=run.id%>'><%=run.task%> #<%=run.id%></a></td>
	            <td><%=run.status%></td>
	            <td><%=run.duration%></td>
	            <td><%=run.by%></td>
	            <td><%=run?.user?.name%></td>
	        </tr>
	        <%})%>
	    </tbody>
	</table>
</div>
